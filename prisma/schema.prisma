generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// AUTH MODELS
// ============================================

model otp_verifications {
  id          String   @id @default(uuid())
  email       String
  phoneNumber String
  password    String
  firstName   String
  lastName    String
  fullName    String
  otp         String
  expiresAt   DateTime
  createdAt   DateTime @default(now())
}

model PasswordReset {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  otp       String
  verified  Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("password_resets")
}

// ============================================
// USER MODEL
// ============================================

model User {
  id                    String           @id @default(uuid())
  email                 String           @unique
  phoneNumber           String           @unique
  password              String
  firstName             String
  lastName              String
  fullName              String
  isVerified            Boolean          @default(true)
  hasPasskey            Boolean          @default(false)
  hasPickedMembership   Boolean          @default(false)
  passkey               String?
  isActive              Boolean          @default(true)
  isBanned              Boolean          @default(false)
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt

  // Device info for push notifications
  fcmToken              String?
  devicePlatform        String?

  // Wallet setup tracking
  walletSetupStep       WalletSetupStep  @default(NOT_STARTED)
  walletSetupData       Json?

  // KYC fields
  bvn                   String?
  bvnData               Json?
  nin                   String?
  ninData               Json?
  dob                   String?
  gender                String?

  // Address fields
  address               String?
  state                 String?
  lga                   String?
  city                  String?

  // Document fields
  photo                 String?
  proofOfAddress        String?
  skippedProofOfAddress Boolean          @default(false)

  // Transaction PIN (for wallet transactions)
  transactionPin        String?

  // Relations
  passwordResets        PasswordReset[]
  memberships           Membership[]
  wallets               Wallet[]
  joinRequests          JoinRequest[]
  withdrawalAccount     WithdrawalAccount?

  @@map("users")
}

// ============================================
// COMMUNITY MODELS
// ============================================

model Community {
  id                  String             @id @default(uuid())
  name                String             @unique
  description         String?
  logo                String?
  color               String?
  isDefault           Boolean            @default(false)
  isActive            Boolean            @default(true)
  isRegistered        Boolean            @default(false)
  proofOfAddress      String?
  cacDocument         String?
  addressVerification String?
  createdById         String?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt

  invites             CommunityInvite[]
  communityWallet     community_wallets?
  joinRequests        JoinRequest[]
  members             Membership[]

  @@map("communities")
}

model CommunityInvite {
  id            String        @id @default(uuid())
  communityId   String
  type          InviteType    @default(LINK)
  joinType      JoinType      @default(OPEN)
  token         String        @unique
  email         String?
  maxMembers    Int?
  usedCount     Int           @default(0)
  expiresAt     DateTime?
  isActive      Boolean       @default(true)
  invitedById   String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  community     Community     @relation(fields: [communityId], references: [id], onDelete: Cascade)
  joinRequests  JoinRequest[]

  @@index([communityId])
  @@index([token])
  @@map("community_invites")
}

model Membership {
  id          String        @id @default(uuid())
  userId      String
  communityId String
  role        CommunityRole @default(MEMBER)
  isActive    Boolean       @default(true)
  joinedAt    DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  community   Community     @relation(fields: [communityId], references: [id], onDelete: Cascade)

  @@unique([userId, communityId])
  @@index([userId])
  @@index([communityId])
  @@map("memberships")
}

model JoinRequest {
  id          String            @id @default(uuid())
  userId      String
  communityId String
  inviteId    String?
  status      JoinRequestStatus @default(PENDING)
  respondedBy String?
  respondedAt DateTime?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  community   Community         @relation(fields: [communityId], references: [id], onDelete: Cascade)
  invite      CommunityInvite?  @relation(fields: [inviteId], references: [id])

  @@unique([userId, communityId])
  @@index([communityId])
  @@index([status])
  @@map("join_requests")
}

// ============================================
// WALLET MODELS
// ============================================

model Wallet {
  id                    String      @id @default(uuid())
  userId                String
  walletType            WalletType  @default(MAIN)
  balance               Float       @default(0)
  totalDeposit          Float       @default(0)
  totalWithdraw         Float       @default(0)
  isActive              Boolean     @default(true)
  isDeleted             Boolean     @default(false)
  isBanned              Boolean     @default(false)
  externalWalletId      String?
  externalWalletDetails Json?
  transactionPin        String?
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt

  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, walletType])
  @@index([userId])
  @@map("wallets")
}

model community_wallets {
  id                    String       @id @default(uuid())
  communityId           String       @unique
  balance               Decimal      @default(0) @db.Decimal(12, 2)
  signatories           Json?        // Array of signatory user IDs [{userId, role: "ADMIN"/"CO_ADMIN"}]
  approvalRule          ApprovalRule @default(FIFTY_PERCENT)
  transactionPin        String?      // Hashed PIN for community wallet transactions
  externalWalletId      String?
  externalWalletDetails Json?
  isActive              Boolean      @default(true)
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt

  community             Community    @relation(fields: [communityId], references: [id], onDelete: Cascade)
}

model Transaction {
  id              String            @id @default(uuid())
  userId          String
  walletId        String
  amount          Float
  transactionType TransactionType
  reason          String?
  reference       String            @unique
  externalRef     String?
  status          TransactionStatus @default(PENDING)
  details         Json?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([userId])
  @@index([walletId])
  @@index([reference])
  @@map("transactions")
}

model WebhookLog {
  id         String   @id @default(uuid())
  source     String
  rawPayload Json
  status     String
  message    String?
  createdAt  DateTime @default(now())

  @@index([source])
  @@index([status])
  @@map("webhook_logs")
}

model WithdrawalAccount {
  id            String   @id @default(uuid())
  userId        String   @unique
  bankCode      String
  bankName      String
  accountNumber String
  accountName   String
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("withdrawal_accounts")
}

// ============================================
// ESUSU MODELS
// ============================================

model Esusu {
  id                      String              @id @default(uuid())
  communityId             String
  creatorId               String
  name                    String
  description             String?
  iconUrl                 String?
  numberOfParticipants    Int
  contributionAmount      Decimal             @db.Decimal(12, 2)
  frequency               PaymentFrequency
  participationDeadline   DateTime
  collectionDate          DateTime
  takeCommission          Boolean             @default(false)
  commissionPercentage    Int?                // 1-50
  platformFeePercentage   Decimal             @default(1.5) @db.Decimal(5, 2)
  payoutOrderType         PayoutOrderType
  status                  EsusuStatus         @default(PENDING_MEMBERS)
  currentCycle            Int                 @default(0)
  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt

  participants            EsusuParticipant[]
  cycles                  EsusuCycle[]

  @@unique([communityId, name, status])
  @@index([communityId])
  @@index([creatorId])
  @@index([status])
  @@map("esusus")
}

model EsusuParticipant {
  id                String                    @id @default(uuid())
  esusuId           String
  userId            String
  slotNumber        Int?                      // Assigned after acceptance or deadline
  inviteStatus      EsusuInviteStatus         @default(INVITED)
  invitedAt         DateTime                  @default(now())
  respondedAt       DateTime?
  isCreator         Boolean                   @default(false)
  totalContributed  Decimal                   @default(0) @db.Decimal(12, 2)
  totalReceived     Decimal                   @default(0) @db.Decimal(12, 2)
  defaultCount      Int                       @default(0)
  createdAt         DateTime                  @default(now())
  updatedAt         DateTime                  @updatedAt

  esusu             Esusu                     @relation(fields: [esusuId], references: [id], onDelete: Cascade)
  contributions     EsusuContribution[]

  @@unique([esusuId, userId])
  @@index([esusuId])
  @@index([userId])
  @@map("esusu_participants")
}

model EsusuCycle {
  id                String              @id @default(uuid())
  esusuId           String
  cycleNumber       Int
  startDate         DateTime
  endDate           DateTime
  payoutDate        DateTime
  receiverId        String?             // User ID of the receiver for this cycle
  expectedPool      Decimal             @db.Decimal(12, 2)
  collectedAmount   Decimal             @default(0) @db.Decimal(12, 2)
  platformFee       Decimal             @db.Decimal(12, 2)
  commission        Decimal             @default(0) @db.Decimal(12, 2)
  netPayout         Decimal             @db.Decimal(12, 2)
  status            EsusuCycleStatus    @default(UPCOMING)
  payoutStatus      PayoutStatus        @default(PENDING)
  payoutAt          DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  esusu             Esusu               @relation(fields: [esusuId], references: [id], onDelete: Cascade)
  contributions     EsusuContribution[]
  payout            EsusuPayout?

  @@unique([esusuId, cycleNumber])
  @@index([esusuId])
  @@index([receiverId])
  @@map("esusu_cycles")
}

model EsusuContribution {
  id              String                    @id @default(uuid())
  esusuId         String
  cycleId         String
  participantId   String
  userId          String
  amount          Decimal                   @db.Decimal(12, 2)
  status          ContributionStatus        @default(PENDING)
  dueDate         DateTime
  paidAt          DateTime?
  transactionRef  String?
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt

  cycle           EsusuCycle                @relation(fields: [cycleId], references: [id], onDelete: Cascade)
  participant     EsusuParticipant          @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@unique([cycleId, participantId])
  @@index([esusuId])
  @@index([cycleId])
  @@index([userId])
  @@map("esusu_contributions")
}

model EsusuPayout {
  id              String        @id @default(uuid())
  esusuId         String
  cycleId         String        @unique
  receiverId      String
  grossAmount     Decimal       @db.Decimal(12, 2)
  platformFee     Decimal       @db.Decimal(12, 2)
  commission      Decimal       @default(0) @db.Decimal(12, 2)
  netAmount       Decimal       @db.Decimal(12, 2)
  status          PayoutStatus  @default(PENDING)
  transactionRef  String?
  processedAt     DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  cycle           EsusuCycle    @relation(fields: [cycleId], references: [id], onDelete: Cascade)

  @@index([esusuId])
  @@index([receiverId])
  @@map("esusu_payouts")
}

// ============================================
// ENUMS
// ============================================

enum WalletSetupStep {
  NOT_STARTED
  BVN_VERIFIED
  PERSONAL_INFO
  FACE_VERIFIED
  PROOF_OF_ADDRESS
  COMPLETED
}

enum WalletType {
  MAIN
  SAVINGS
  GROUPBUYING
  ESUSU
  CONTRIBUTION
}

enum CommunityRole {
  ADMIN
  CO_ADMIN
  MEMBER
}

enum InviteType {
  LINK
  EMAIL
}

enum JoinType {
  OPEN
  APPROVAL_REQUIRED
}

enum JoinRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum TransactionType {
  CREDIT
  DEBIT
  TRANSFER
  DEPOSIT
  WITHDRAWAL
}

enum TransactionStatus {
  PENDING
  SUCCESS
  FAILED
}

enum ApprovalRule {
  THIRTY_PERCENT
  FIFTY_PERCENT
  SEVENTY_FIVE_PERCENT
  HUNDRED_PERCENT
}

// Esusu Enums
enum PaymentFrequency {
  WEEKLY
  MONTHLY
  QUARTERLY
}

enum PayoutOrderType {
  RANDOM
  FIRST_COME_FIRST_SERVED
}

enum EsusuStatus {
  PENDING_MEMBERS     // Waiting for participants to accept
  READY_TO_START      // All accepted, waiting for collection date
  ACTIVE              // Cycles running
  COMPLETED           // All cycles done
  CANCELLED           // Cancelled by admin or system
  PAUSED              // Temporarily paused
}

enum EsusuInviteStatus {
  INVITED
  ACCEPTED
  DECLINED
  EXPIRED
}

enum EsusuCycleStatus {
  UPCOMING
  ACTIVE
  COLLECTING
  PAYOUT_PENDING
  COMPLETED
}

enum ContributionStatus {
  PENDING
  PAID
  LATE
  UNPAID
  DEFAULTED
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}
